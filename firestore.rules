rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // =====================================================
    // USERS COLLECTION - Enhanced Rules for Duplicate Check
    // =====================================================
    match /users/{userId} {
      // ✅ CHO PHÉP ĐỌC EMAIL - cho duplicate check khi CHƯA ĐĂNG NHẬP
      // Chỉ cho phép đọc field 'email' và 'providers'
      allow get: if request.auth == null &&
                    resource.data.keys().hasOnly(['email', 'providers', 'displayName', 'photoURL', 'createdAt', 'emailVerified', 'lastLoginAt', 'loginMethod', 'selectedTopics']);

      // ✅ CHO PHÉP QUERY BY EMAIL - cho duplicate check
      allow list: if request.auth == null &&
                     request.query.limit <= 1;

      // ✅ USER ĐÃ ĐĂNG NHẬP - full access to own document
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // ✅ CREATE USER - cho phép tạo document mới khi signup
      allow create: if request.auth != null && request.auth.uid == userId;

      // =====================================================
      // NOTIFICATION HISTORY - Lịch sử thông báo riêng cho từng user
      // =====================================================
      match /notification_history/{notificationId} {
        // ✅ CHỈ USER ĐÃ ĐĂNG NHẬP MỚI TRUY CẬP ĐƯỢC LỊCH SỬ CỦA CHÍNH HỌ
        allow read, write: if request.auth != null && request.auth.uid == userId;

        // ✅ VALIDATE DỮ LIỆU KHI TẠO/CẬP NHẬT
        allow create, update: if request.auth != null &&
                                 request.auth.uid == userId &&
                                 request.resource.data.keys().hasAll(['id', 'title', 'body', 'source', 'timestamp', 'isRead']) &&
                                 request.resource.data.title is string &&
                                 request.resource.data.title.size() > 0 &&
                                 request.resource.data.body is string &&
                                 request.resource.data.source is string &&
                                 request.resource.data.timestamp is string &&
                                 request.resource.data.isRead is bool;
      }

      // =====================================================
      // FAVORITE TOPICS - Chủ đề yêu thích của user
      // =====================================================
      match /favorite_topics/{topicId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // =====================================================
    // BOOKMARKS - User chỉ truy cập bookmark của chính họ
    // =====================================================
    match /users/{userId}/bookmarks/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // =====================================================
    // READING HISTORY - User chỉ truy cập lịch sử của chính họ
    // =====================================================
    match /users/{userId}/reading_history/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // =====================================================
    // ARTICLE SUMMARIES - AI Tóm Tắt Bài Báo
    // =====================================================
    match /article_summaries/{summaryId} {
      // ✅ CHO PHÉP ĐỌC CHO TẤT CẢ - cache summary là public
      // Bất kỳ ai cũng có thể đọc tóm tắt đã được tạo
      allow read: if true;

      // ✅ CHỈ USER ĐÃ ĐĂNG NHẬP MỚI GHI ĐƯỢC
      // Ngăn spam và abuse từ anonymous users
      allow write: if request.auth != null;

      // ✅ VALIDATE DỮ LIỆU - đảm bảo structure đúng
      allow create, update: if request.auth != null &&
                               request.resource.data.keys().hasAll(['summary', 'articleId']) &&
                               request.resource.data.summary is string &&
                               request.resource.data.summary.size() > 0 &&
                               request.resource.data.summary.size() <= 5000;
    }

    // =====================================================
    // SYSTEM COLLECTION - For Cloud Functions
    // =====================================================
    match /system/{document=**} {
      allow read: if true;
      allow write: if false; // Only Cloud Functions can write
    }
  }
}

